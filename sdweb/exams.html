<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>考前衝剌系統 - 模擬試題卷</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-color: #333;
            --light-bg: #f4f7f6;
            --card-bg: #fff;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-bg);
            padding-top: 60px;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo i {
            font-size: 1.8rem;
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin-left: 20px;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        nav ul li a:hover,
        nav ul li a.active {
            background-color: var(--primary-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--primary-dark);
        }

        .page-subtitle {
            color: #777;
            margin-bottom: 20px;
        }

        .section {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: var(--primary-dark);
        }

        .btn-success {
            background-color: var(--secondary-color);
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        /* 試卷列表樣式 */
        .exams-list-container {
            overflow-x: auto;
        }

        .exams-list {
            width: 100%;
            border-collapse: collapse;
        }

        .exams-list th,
        .exams-list td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .exams-list th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .exams-list tr:hover {
            background-color: #f5f5f5;
        }

        .exams-list .actions {
            display: flex;
            gap: 8px;
        }

        /* 測驗生成表單樣式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item input {
            width: auto;
        }

        /* 題庫管理樣式 */
        .questions-list-container {
            overflow-x: auto;
        }

        .questions-list {
            width: 100%;
            border-collapse: collapse;
        }

        .questions-list th,
        .questions-list td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .questions-list th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .questions-list tr:hover {
            background-color: #f5f5f5;
        }

        .questions-list .actions {
            display: flex;
            gap: 8px;
        }

        /* 標籤樣式 */
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
            background-color: #e1f5fe;
            color: #0288d1;
        }

        .tag-easy {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .tag-medium {
            background-color: #fff8e1;
            color: #ffa000;
        }

        .tag-hard {
            background-color: #ffebee;
            color: #d32f2f;
        }

        /* 模態框樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 1.5rem;
            color: #aaa;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #555;
        }

        /* 考試結果樣式 */
        .result-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .result-card {
            flex: 1;
            background-color: #f2f2f2;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .result-score {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .high-score {
            color: var(--secondary-color);
        }

        .medium-score {
            color: var(--warning-color);
        }

        .low-score {
            color: var(--danger-color);
        }

        .question-review-list {
            margin-top: 20px;
        }

        .question-review-item {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .question-review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .question-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .status-correct {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .status-wrong {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .question-review-content {
            margin-bottom: 10px;
        }

        .answer-comparison {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .correct-answer,
        .user-answer {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
        }

        .correct-answer {
            background-color: #e8f5e9;
        }

        .user-answer {
            background-color: #ffebee;
        }

        /* 考試頁面樣式 */
        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .exam-timer {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #f2f2f2;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 1.2rem;
        }

        .timer-running {
            color: var(--primary-color);
        }

        .timer-warning {
            color: var(--warning-color);
        }

        .timer-danger {
            color: var(--danger-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .question-container {
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }

        .question-number {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-dark);
        }

        .question-content {
            margin-bottom: 15px;
        }

        .options-container {
            margin-top: 10px;
        }

        .option-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .option-item:hover {
            background-color: #f2f2f2;
        }

        .option-item.selected {
            background-color: #e1f5fe;
            border-color: var(--primary-color);
        }

        .option-input {
            margin-top: 3px;
        }

        .option-text {
            flex: 1;
        }

        .fill-blank-container {
            margin-top: 10px;
        }

        .fill-blank-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .short-answer-container {
            margin-top: 10px;
        }

        .short-answer-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 100px;
            resize: vertical;
        }

        .exam-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .question-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 20px 0;
            justify-content: center;
        }

        .question-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f2f2f2;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .question-dot.active {
            background-color: var(--primary-color);
            color: white;
        }

        .question-dot.answered {
            background-color: var(--secondary-color);
            color: white;
        }

        .exam-submit {
            text-align: center;
            margin-top: 30px;
        }

        .exam-submit button {
            padding: 10px 20px;
            font-size: 1rem;
        }

        /* 數據圖表區塊 */
        .chart-container {
            min-height: 300px;
            margin: 20px 0;
        }

        /* 統計卡片樣式 */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-card .stat-label {
            color: #777;
            font-size: 0.9rem;
        }

        /* 答題分析 */
        .analysis-container {
            margin-top: 20px;
        }

        .analysis-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .analysis-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-dark);
        }

        /* 提示和引導樣式 */
        .tip-box {
            background-color: #e1f5fe;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .tip-box .tip-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .result-summary {
                flex-direction: column;
            }

            .answer-comparison {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- 引入Font Awesome圖標庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- 引入HighCharts圖表庫 -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <!-- 引入公用工具JS -->
    <script src="js/common.js"></script>
</head>

<body>
    <header>
        <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            <span>考前衝剌系統</span>
        </div>
        <nav>
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-home"></i> 首頁</a></li>
                <li><a href="scores.html"><i class="fas fa-chart-line"></i> 成績記錄</a></li>
                <li><a href="plans.html"><i class="fas fa-calendar-alt"></i> 複習計畫</a></li>
                <li><a href="exams.html" class="active"><i class="fas fa-file-alt"></i> 模擬試題</a></li>
                <li><a href="wrong-questions.html"><i class="fas fa-exclamation-circle"></i> 錯題整理</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">模擬試題卷系統</h1>
            <p class="page-subtitle">生成個性化模擬試題，檢測學習成果，提高應試能力</p>
        </div>

        <!-- 快速入口區 -->
        <div class="section">
            <div class="stats-cards">
                <div class="stat-card">
                    <i class="fas fa-file-alt fa-2x" style="color: var(--primary-color);"></i>
                    <div class="stat-value" id="total-exams-count">0</div>
                    <div class="stat-label">我的試卷</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle fa-2x" style="color: var(--secondary-color);"></i>
                    <div class="stat-value" id="completed-exams-count">0</div>
                    <div class="stat-label">已完成測驗</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-graduation-cap fa-2x" style="color: var(--warning-color);"></i>
                    <div class="stat-value" id="avg-score">0</div>
                    <div class="stat-label">平均分數</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-question-circle fa-2x" style="color: var(--danger-color);"></i>
                    <div class="stat-value" id="total-questions-count">0</div>
                    <div class="stat-label">題庫總數</div>
                </div>
            </div>

            <div class="section-header">
                <h2 class="section-title">快速操作</h2>
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                <button class="btn" id="create-exam-btn"><i class="fas fa-plus"></i> 生成新試卷</button>
                <button class="btn" id="add-question-btn"><i class="fas fa-question-circle"></i> 添加題目</button>
                <button class="btn" id="view-all-results-btn"><i class="fas fa-chart-bar"></i> 查看所有結果</button>
                <button class="btn" id="import-questions-btn"><i class="fas fa-file-import"></i> 導入題目</button>
            </div>

            <div class="tip-box">
                <div class="tip-title"><i class="fas fa-lightbulb"></i> 學習提示</div>
                <p>定期進行模擬測驗可以幫助你評估學習進度並找出需要加強的薄弱環節。建議先設定明確目標，再依據知識點和難度生成適合的試卷。</p>
            </div>
        </div>

        <!-- 已有試卷區塊 -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">我的試卷</h2>
                <div class="exam-filter" style="display: flex; gap: 10px;">
                    <select id="filter-subject" class="exam-filter-control">
                        <option value="all">全部科目</option>
                        <option value="chinese">國文</option>
                        <option value="english">英文</option>
                        <option value="math">數學</option>
                        <option value="science">自然</option>
                        <option value="social">社會</option>
                    </select>
                    <select id="filter-status" class="exam-filter-control">
                        <option value="all">全部狀態</option>
                        <option value="completed">已完成</option>
                        <option value="pending">未完成</option>
                    </select>
                </div>
            </div>
            <div class="exams-list-container">
                <table class="exams-list" id="exams-list">
                    <thead>
                        <tr>
                            <th>試卷名稱</th>
                            <th>科目</th>
                            <th>學年</th>
                            <th>題數</th>
                            <th>時間</th>
                            <th>創建日期</th>
                            <th>狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 試卷列表將透過JavaScript動態填充 -->
                    </tbody>
                </table>
            </div>
            <div id="no-exams-message" style="text-align: center; padding: 20px; display: none;">
                尚無模擬試卷，請點擊上方「生成新試卷」按鈕創建
            </div>
        </div>

        <!-- 近期考試結果 -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">近期考試結果</h2>
                <button class="btn" id="see-results-btn"><i class="fas fa-list"></i> 查看所有結果</button>
            </div>
            <div id="recent-results-container">
                <!-- 近期考試結果將透過JavaScript動態填充 -->
            </div>
            <div id="no-results-message" style="text-align: center; padding: 20px; display: none;">
                尚無考試結果，完成模擬試卷後將顯示在此處
            </div>

            <!-- 成績趨勢圖 -->
            <div class="chart-container" id="score-trend-chart"></div>
        </div>

        <!-- 學習分析區 -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">學習分析</h2>
            </div>

            <div class="analysis-container" id="learning-analysis">
                <!-- 分析內容將通過JavaScript動態生成 -->
            </div>

            <div id="no-analysis-message" style="text-align: center; padding: 20px; display: none;">
                需要完成至少3次測驗才能生成學習分析
            </div>
        </div>

        <!-- 題庫管理 -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">題庫管理</h2>
                <div>
                    <button class="btn" id="add-question-btn2"><i class="fas fa-plus"></i> 添加題目</button>
                    <button class="btn" id="import-questions-btn2"><i class="fas fa-file-import"></i> 導入題目</button>
                </div>
            </div>
            <div class="questions-filter" style="margin-bottom: 15px;">
                <div class="form-row">
                    <div class="form-col">
                        <label for="filter-question-subject">科目：</label>
                        <select id="filter-question-subject">
                            <option value="all">全部科目</option>
                            <option value="chinese">國文</option>
                            <option value="english">英文</option>
                            <option value="math">數學</option>
                            <option value="science">自然</option>
                            <option value="social">社會</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="filter-type">題型：</label>
                        <select id="filter-type">
                            <option value="all">全部題型</option>
                            <option value="true_false">是非題</option>
                            <option value="single_choice">單選題</option>
                            <option value="multiple_choice">多選題</option>
                            <option value="fill_blank">填空題</option>
                            <option value="short_answer">簡答題</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="filter-difficulty">難度：</label>
                        <select id="filter-difficulty">
                            <option value="all">全部難度</option>
                            <option value="easy">基礎</option>
                            <option value="medium">中等</option>
                            <option value="hard">進階</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="search-questions">搜尋：</label>
                        <input type="text" id="search-questions" placeholder="搜尋題目內容或關鍵字...">
                    </div>
                </div>
            </div>
            <div class="questions-list-container">
                <table class="questions-list" id="questions-list">
                    <thead>
                        <tr>
                            <th>題型</th>
                            <th>科目</th>
                            <th>學年</th>
                            <th>題目內容</th>
                            <th>難度</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 題目列表將透過JavaScript動態填充 -->
                    </tbody>
                </table>
            </div>
            <div id="no-questions-message" style="text-align: center; padding: 20px; display: none;">
                題庫中尚無題目，請點擊「添加題目」按鈕新增
            </div>

            <!-- 題型分布圖 -->
            <div class="chart-container" id="question-types-chart"></div>
        </div>
    </div>

    <!-- 生成試卷模態框 -->
    <div class="modal" id="create-exam-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>生成新模擬試卷</h2>
            <form id="generate-exam-form">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="exam-title">試卷名稱*</label>
                            <input type="text" id="exam-title" name="title" required placeholder="例如：數學期中模擬考">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="exam-description">描述</label>
                            <input type="text" id="exam-description" name="description" placeholder="(選填)簡要描述此試卷的目的">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="exam-subject">科目*</label>
                            <select id="exam-subject" name="subject" required>
                                <option value="">請選擇科目</option>
                                <option value="chinese">國文</option>
                                <option value="english">英文</option>
                                <option value="math">數學</option>
                                <option value="science">自然</option>
                                <option value="social">社會</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="exam-academic-year">學年*</label>
                            <select id="exam-academic-year" name="academic_year" required>
                                <option value="">請選擇學年</option>
                                <option value="國一">國一</option>
                                <option value="國二">國二</option>
                                <option value="國三">國三</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="exam-total-time">考試時間（分鐘）*</label>
                            <input type="number" id="exam-total-time" name="total_time" min="5" max="180" value="60"
                                required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="exam-total-score">總分*</label>
                            <input type="number" id="exam-total-score" name="total_score" min="10" max="200" value="100"
                                required>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="exam-questions-count">題目數量*</label>
                            <input type="number" id="exam-questions-count" name="questions_count" min="1" max="100"
                                value="20" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="exam-difficulty">難度*</label>
                            <select id="exam-difficulty" name="difficulty" required>
                                <option value="easy">基礎</option>
                                <option value="medium" selected>中等</option>
                                <option value="hard">進階</option>
                                <option value="mixed">混合難度</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>題型選擇*</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="type-true-false" name="true_false" checked>
                            <label for="type-true-false">是非題</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="type-single-choice" name="single_choice" checked>
                            <label for="type-single-choice">單選題</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="type-multiple-choice" name="multiple_choice" checked>
                            <label for="type-multiple-choice">多選題</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="type-fill-blank" name="fill_blank">
                            <label for="type-fill-blank">填空題</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="type-short-answer" name="short_answer">
                            <label for="type-short-answer">簡答題</label>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">生成試卷</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 題目詳情模態框 -->
    <div class="modal" id="question-detail-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="question-detail-content">
                <!-- 題目詳情內容將透過JavaScript動態填充 -->
            </div>
        </div>
    </div>

    <!-- 添加題目模態框 -->
    <div class="modal" id="add-question-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>添加新題目</h2>
            <form id="add-question-form">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="question-subject">科目*</label>
                            <select id="question-subject" name="subject" required>
                                <option value="">請選擇科目</option>
                                <option value="chinese">國文</option>
                                <option value="english">英文</option>
                                <option value="math">數學</option>
                                <option value="science">自然</option>
                                <option value="social">社會</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="question-academic-year">學年*</label>
                            <select id="question-academic-year" name="academic_year" required>
                                <option value="">請選擇學年</option>
                                <option value="國一">國一</option>
                                <option value="國二">國二</option>
                                <option value="國三">國三</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="question-type">題型*</label>
                            <select id="question-type" name="question_type" required>
                                <option value="">請選擇題型</option>
                                <option value="true_false">是非題</option>
                                <option value="single_choice">單選題</option>
                                <option value="multiple_choice">多選題</option>
                                <option value="fill_blank">填空題</option>
                                <option value="short_answer">簡答題</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="question-difficulty">難度*</label>
                            <select id="question-difficulty" name="difficulty" required>
                                <option value="">請選擇難度</option>
                                <option value="easy">基礎</option>
                                <option value="medium">中等</option>
                                <option value="hard">進階</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="question-chapter">章節</label>
                            <input type="text" id="question-chapter" name="chapter" placeholder="(選填)章節或知識點">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="question-time-limit">作答時間（秒）</label>
                            <input type="number" id="question-time-limit" name="time_limit" min="10" max="600"
                                value="60">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="question-content">題目內容*</label>
                    <textarea id="question-content" name="content" rows="4" required
                        placeholder="請輸入題目內容..."></textarea>
                </div>
                <!-- 不同題型的答案輸入區域，將根據選擇的題型顯示 -->
                <div id="answer-container">
                    <!-- 是非題答案區域 -->
                    <div id="true-false-answer" class="answer-section" style="display: none;">
                        <div class="form-group">
                            <label>正確答案*</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="radio" id="tf-true" name="tf_answer" value="true" required>
                                    <label for="tf-true">正確</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" id="tf-false" name="tf_answer" value="false">
                                    <label for="tf-false">錯誤</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 單選題答案區域 -->
                    <div id="single-choice-answer" class="answer-section" style="display: none;">
                        <div class="form-group">
                            <label>選項與答案*</label>
                            <div class="options-container" id="single-options-container">
                                <div class="option-group">
                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <input type="radio" name="single_answer" class="option-checkbox" required>
                                        <input type="text" class="option-text" placeholder="選項內容" required>
                                        <button type="button" class="btn btn-danger remove-option">刪除</button>
                                    </div>
                                </div>
                                <div class="option-group">
                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <input type="radio" name="single_answer" class="option-checkbox" required>
                                        <input type="text" class="option-text" placeholder="選項內容" required>
                                        <button type="button" class="btn btn-danger remove-option">刪除</button>
                                    </div>
                                </div>
                                <button type="button" class="btn" id="add-single-option">增加選項</button>
                            </div>
                        </div>
                    </div>
                    <!-- 多選題答案區域 -->
                    <div id="multiple-choice-answer" class="answer-section" style="display: none;">
                        <div class="form-group">
                            <label>選項與答案*</label>
                            <div class="options-container" id="multiple-options-container">
                                <div class="option-group">
                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <input type="checkbox" class="option-checkbox">
                                        <input type="text" class="option-text" placeholder="選項內容" required>
                                        <button type="button" class="btn btn-danger remove-option">刪除</button>
                                    </div>
                                </div>
                                <div class="option-group">
                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <input type="checkbox" class="option-checkbox">
                                        <input type="text" class="option-text" placeholder="選項內容" required>
                                        <button type="button" class="btn btn-danger remove-option">刪除</button>
                                    </div>
                                </div>
                                <button type="button" class="btn" id="add-multiple-option">增加選項</button>
                            </div>
                        </div>
                    </div>
                    <!-- 填空題答案區域 -->
                    <div id="fill-blank-answer" class="answer-section" style="display: none;">
                        <div class="form-group">
                            <label>填空答案*</label>
                            <div id="blanks-container">
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" class="blank-answer" placeholder="請輸入填空1的答案" required>
                                    <button type="button" class="btn btn-danger remove-blank">刪除</button>
                                </div>
                            </div>
                            <button type="button" class="btn" id="add-blank">增加填空</button>
                            <small style="display: block; margin-top: 5px;">提示：題目中使用 ____ 表示填空位置</small>
                        </div>
                    </div>
                    <!-- 簡答題答案區域 -->
                    <div id="short-answer-answer" class="answer-section" style="display: none;">
                        <div class="form-group">
                            <label for="short-answer">參考答案*</label>
                            <textarea id="short-answer" name="short_answer" rows="3" placeholder="請輸入參考答案..."
                                required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="keywords">關鍵詞（用於自動評分，多個關鍵詞請用逗號分隔）</label>
                            <input type="text" id="keywords" name="keywords" placeholder="例如：牛頓,第二定律,F=ma">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="question-explanation">解析</label>
                    <textarea id="question-explanation" name="explanation" rows="3"
                        placeholder="(選填)題目解析或說明..."></textarea>
                </div>
                <div class="form-group">
                    <label for="question-tags">標籤（多個標籤請用逗號分隔）</label>
                    <input type="text" id="question-tags" name="tags" placeholder="例如：力學,物理,牛頓定律">
                </div>
                <div class="form-group" style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">添加題目</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 試卷結果模態框 -->
    <div class="modal" id="exam-result-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="exam-result-content">
                <!-- 考試結果內容將透過JavaScript動態填充 -->
            </div>
        </div>
    </div>

    <!-- 導入題目模態框 -->
    <div class="modal" id="import-questions-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>導入題目</h2>
            <div class="form-group">
                <label for="import-format">導入格式</label>
                <select id="import-format">
                    <option value="json">JSON格式</option>
                    <option value="csv">CSV格式</option>
                    <option value="excel">Excel格式</option>
                </select>
            </div>
            <div class="form-group">
                <label for="import-file">選擇檔案</label>
                <input type="file" id="import-file" accept=".json,.csv,.xlsx">
            </div>
            <div class="form-group">
                <label>或貼上JSON/CSV內容</label>
                <textarea id="import-content" rows="10" placeholder="請貼上JSON或CSV格式的題目數據..."></textarea>
            </div>
            <div class="tip-box">
                <div class="tip-title"><i class="fas fa-info-circle"></i> 格式說明</div>
                <p>JSON格式需包含題目類型、內容、選項、答案等必要欄位。CSV需按照指定格式排列。詳細規範請參考<a href="#" id="format-help">導入格式說明</a>。</p>
            </div>
            <div class="form-group" style="text-align: center; margin-top: 20px;">
                <button type="button" class="btn" id="download-template">下載模板</button>
                <button type="button" class="btn btn-success" id="import-questions-btn-submit">導入題目</button>
            </div>
        </div>
    </div>

    <!-- 所有結果模態框 -->
    <div class="modal" id="all-results-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>所有測驗結果</h2>
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="result-filter-subject">科目：</label>
                        <select id="result-filter-subject">
                            <option value="all">全部科目</option>
                            <option value="chinese">國文</option>
                            <option value="english">英文</option>
                            <option value="math">數學</option>
                            <option value="science">自然</option>
                            <option value="social">社會</option>
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="result-filter-date">時間範圍：</label>
                        <select id="result-filter-date">
                            <option value="all">全部時間</option>
                            <option value="week">最近一週</option>
                            <option value="month">最近一個月</option>
                            <option value="quarter">最近三個月</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="all-results-container">
                <!-- 所有結果將通過JavaScript動態填充 -->
            </div>
            <div id="no-all-results-message" style="text-align: center; padding: 20px; display: none;">
                尚無測驗結果記錄
            </div>
        </div>
    </div>

    <!-- 引入系統模塊的JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/scoreRecord.js"></script>
    <script src="js/wrongQuestionManager.js"></script>
    <script src="js/examSystem.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化統計數字
            updateStatistics();

            // 初始化試卷列表
            updateExamsList();

            // 初始化問題列表
            updateQuestionsList();

            // 初始化近期考試結果
            updateRecentResults();

            // 初始化學習分析
            updateLearningAnalysis();

            // 初始化圖表
            initializeCharts();

            // 修復按鈕點擊無反應的問題
            // 點擊生成新試卷按鈕
            document.getElementById('create-exam-btn').addEventListener('click', function () {
                document.getElementById('create-exam-modal').style.display = 'block';
                if (window.sdUtils) {
                    window.sdUtils.showNotification('已打開試卷生成面板', 'info');
                }
            });

            // 點擊添加題目按鈕
            document.getElementById('add-question-btn').addEventListener('click', function () {
                document.getElementById('add-question-modal').style.display = 'block';
                if (window.sdUtils) {
                    window.sdUtils.showNotification('已打開添加題目面板', 'info');
                }
            });

            document.getElementById('add-question-btn2').addEventListener('click', function () {
                document.getElementById('add-question-modal').style.display = 'block';
                if (window.sdUtils) {
                    window.sdUtils.showNotification('已打開添加題目面板', 'info');
                }
            });

            // 點擊查看所有結果按鈕
            document.getElementById('view-all-results-btn').addEventListener('click', function () {
                document.getElementById('all-results-modal').style.display = 'block';
                populateAllResults();
                if (window.sdUtils) {
                    window.sdUtils.showNotification('正在載入所有考試結果', 'info');
                }
            });

            document.getElementById('see-results-btn').addEventListener('click', function () {
                document.getElementById('all-results-modal').style.display = 'block';
                populateAllResults();
                if (window.sdUtils) {
                    window.sdUtils.showNotification('正在載入所有考試結果', 'info');
                }
            });

            // 點擊導入題目按鈕
            document.getElementById('import-questions-btn').addEventListener('click', function () {
                document.getElementById('import-questions-modal').style.display = 'block';
                if (window.sdUtils) {
                    window.sdUtils.showNotification('已打開導入題目面板', 'info');
                }
            });

            document.getElementById('import-questions-btn2').addEventListener('click', function () {
                document.getElementById('import-questions-modal').style.display = 'block';
                if (window.sdUtils) {
                    window.sdUtils.showNotification('已打開導入題目面板', 'info');
                }
            });

            // 確保導入題目提交按鈕綁定正確事件
            document.getElementById('import-questions-btn-submit').addEventListener('click', function () {
                // 這裡應該處理導入題目的邏輯，暫時用alert模擬
                alert('題目導入功能尚未實現，請等待系統更新。');
                document.getElementById('import-questions-modal').style.display = 'none';
                if (window.sdUtils) {
                    window.sdUtils.showNotification('題目導入成功', 'success');
                }
            });

            // 確保下載模板按鈕綁定正確事件
            document.getElementById('download-template').addEventListener('click', function () {
                // 這裡應該處理下載模板的邏輯，暫時用alert模擬
                alert('模板下載功能尚未實現，請等待系統更新。');
                if (window.sdUtils) {
                    window.sdUtils.showNotification('開始下載模板', 'info');
                }
            });

            // 確保格式幫助連結綁定正確事件
            document.getElementById('format-help').addEventListener('click', function (e) {
                e.preventDefault();
                alert('導入格式說明功能尚未實現，請等待系統更新。');
            });

            // 題型選擇變更處理
            document.getElementById('question-type').addEventListener('change', function () {
                // 隱藏所有答案區域
                document.querySelectorAll('.answer-section').forEach(function (section) {
                    section.style.display = 'none';
                });

                // 顯示選中的題型答案區域
                const selectedType = this.value;
                if (selectedType === 'true_false') {
                    document.getElementById('true-false-answer').style.display = 'block';
                } else if (selectedType === 'single_choice') {
                    document.getElementById('single-choice-answer').style.display = 'block';
                } else if (selectedType === 'multiple_choice') {
                    document.getElementById('multiple-choice-answer').style.display = 'block';
                } else if (selectedType === 'fill_blank') {
                    document.getElementById('fill-blank-answer').style.display = 'block';
                } else if (selectedType === 'short_answer') {
                    document.getElementById('short-answer-answer').style.display = 'block';
                }
            });

            // 單選題增加選項
            document.getElementById('add-single-option').addEventListener('click', function () {
                const container = document.getElementById('single-options-container');
                const optionGroup = document.createElement('div');
                optionGroup.className = 'option-group';
                optionGroup.innerHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="radio" name="single_answer" class="option-checkbox" required>
                        <input type="text" class="option-text" placeholder="選項內容" required>
                        <button type="button" class="btn btn-danger remove-option">刪除</button>
                    </div>
                `;
                container.insertBefore(optionGroup, this);

                // 綁定刪除按鈕事件
                optionGroup.querySelector('.remove-option').addEventListener('click', function () {
                    container.removeChild(optionGroup);
                });
            });

            // 多選題增加選項
            document.getElementById('add-multiple-option').addEventListener('click', function () {
                const container = document.getElementById('multiple-options-container');
                const optionGroup = document.createElement('div');
                optionGroup.className = 'option-group';
                optionGroup.innerHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" class="option-checkbox">
                        <input type="text" class="option-text" placeholder="選項內容" required>
                        <button type="button" class="btn btn-danger remove-option">刪除</button>
                    </div>
                `;
                container.insertBefore(optionGroup, this);

                // 綁定刪除按鈕事件
                optionGroup.querySelector('.remove-option').addEventListener('click', function () {
                    container.removeChild(optionGroup);
                });
            });

            // 填空題增加填空
            document.getElementById('add-blank').addEventListener('click', function () {
                const container = document.getElementById('blanks-container');
                const blankCount = container.children.length + 1;
                const blankGroup = document.createElement('div');
                blankGroup.style = 'display: flex; gap: 10px; margin-bottom: 10px;';
                blankGroup.innerHTML = `
                    <input type="text" class="blank-answer" placeholder="請輸入填空${blankCount}的答案" required>
                    <button type="button" class="btn btn-danger remove-blank">刪除</button>
                `;
                container.appendChild(blankGroup);

                // 綁定刪除按鈕事件
                blankGroup.querySelector('.remove-blank').addEventListener('click', function () {
                    container.removeChild(blankGroup);
                });
            });

            // 生成試卷表單提交
            document.getElementById('generate-exam-form').addEventListener('submit', function (e) {
                e.preventDefault();

                // 獲取表單數據
                const formData = new FormData(this);
                const examConfig = {
                    title: formData.get('title'),
                    description: formData.get('description') || '模擬測驗',
                    academicYear: formData.get('academic_year'),
                    subject: formData.get('subject'),
                    totalTime: parseInt(formData.get('total_time'), 10) || 60,
                    totalScore: parseInt(formData.get('total_score'), 10) || 100,
                    questionsCount: parseInt(formData.get('questions_count'), 10) || 20,
                    difficulty: formData.get('difficulty'),
                    questionTypes: []
                };

                // 獲取選中的題型
                if (formData.get('true_false')) examConfig.questionTypes.push('true_false');
                if (formData.get('single_choice')) examConfig.questionTypes.push('single_choice');
                if (formData.get('multiple_choice')) examConfig.questionTypes.push('multiple_choice');
                if (formData.get('fill_blank')) examConfig.questionTypes.push('fill_blank');
                if (formData.get('short_answer')) examConfig.questionTypes.push('short_answer');

                // 檢查是否已選擇題型
                if (examConfig.questionTypes.length === 0) {
                    alert('請至少選擇一種題型');
                    return;
                }

                // 調用考試系統生成試卷
                const exam = window.examSystem.generateExam(examConfig);

                if (exam) {
                    // 關閉模態框
                    document.getElementById('create-exam-modal').style.display = 'none';

                    // 更新試卷列表
                    updateExamsList();

                    // 更新統計數字
                    updateStatistics();

                    // 提示生成成功
                    if (window.sdUtils) {
                        window.sdUtils.showNotification(`試卷「${exam.title}」生成成功！`, 'success');
                    } else {
                        alert(`試卷「${exam.title}」生成成功！`);
                    }

                    // 可以選擇立即開始考試
                    if (confirm('是否立即開始考試？')) {
                        window.examSystem.startExam(exam.id);
                    }
                }
            });

            // 添加題目表單提交
            document.getElementById('add-question-form').addEventListener('submit', function (e) {
                e.preventDefault();

                try {
                    // 獲取基本題目數據
                    const questionData = {
                        subject: this.elements.subject.value,
                        academic_year: this.elements.academic_year.value,
                        type: this.elements.question_type.value,
                        difficulty: this.elements.difficulty.value,
                        content: this.elements.content.value,
                        chapter: this.elements.chapter.value,
                        time_limit: parseInt(this.elements.time_limit.value, 10) || 60,
                        explanation: this.elements.explanation.value,
                        tags: this.elements.tags.value ? this.elements.tags.value.split(',').map(tag => tag.trim()) : []
                    };

                    // 根據題型處理答案
                    switch (questionData.type) {
                        case 'true_false':
                            questionData.answer = this.elements.tf_answer.value === 'true';
                            break;

                        case 'single_choice':
                            // 獲取選項和選中的答案
                            const singleOptions = Array.from(document.querySelectorAll('#single-options-container .option-text')).map(input => input.value);
                            const checkedSingleOption = document.querySelector('#single-options-container input[name="single_answer"]:checked');

                            if (!checkedSingleOption) {
                                throw new Error('請選擇一個正確答案');
                            }

                            // 找出選中選項的索引
                            const singleOptionGroups = Array.from(document.querySelectorAll('#single-options-container .option-group'));
                            const singleAnswerIndex = singleOptionGroups.findIndex(group =>
                                group.querySelector('input[name="single_answer"]') === checkedSingleOption
                            );

                            questionData.options = singleOptions;
                            questionData.answer = singleAnswerIndex;
                            break;

                        case 'multiple_choice':
                            // 獲取選項和選中的答案
                            const multipleOptions = Array.from(document.querySelectorAll('#multiple-options-container .option-text')).map(input => input.value);
                            const checkedMultipleOptions = document.querySelectorAll('#multiple-options-container .option-checkbox:checked');

                            if (checkedMultipleOptions.length === 0) {
                                throw new Error('請至少選擇一個正確答案');
                            }

                            // 找出所有選中選項的索引
                            const multipleOptionGroups = Array.from(document.querySelectorAll('#multiple-options-container .option-group'));
                            const multipleAnswerIndices = Array.from(checkedMultipleOptions).map(checkbox => {
                                const group = checkbox.closest('.option-group');
                                return multipleOptionGroups.indexOf(group);
                            });

                            questionData.options = multipleOptions;
                            questionData.answer = multipleAnswerIndices;
                            break;

                        case 'fill_blank':
                            // 獲取所有填空答案
                            questionData.answer = Array.from(document.querySelectorAll('#blanks-container .blank-answer')).map(input => input.value);
                            break;

                        case 'short_answer':
                            questionData.answer = this.elements.short_answer.value;
                            questionData.keywords = this.elements.keywords.value ? this.elements.keywords.value.split(',').map(kw => kw.trim()) : [];
                            break;
                    }

                    // 調用考試系統添加題目
                    if (window.examSystem.addQuestion(questionData)) {
                        // 關閉模態框
                        document.getElementById('add-question-modal').style.display = 'none';

                        // 重置表單
                        this.reset();

                        // 隱藏所有答案區域
                        document.querySelectorAll('.answer-section').forEach(function (section) {
                            section.style.display = 'none';
                        });

                        // 更新題目列表
                        updateQuestionsList();

                        // 更新統計數字
                        updateStatistics();

                        // 提示添加成功
                        if (window.sdUtils) {
                            window.sdUtils.showNotification('題目添加成功！', 'success');
                        } else {
                            alert('題目添加成功！');
                        }
                    }
                } catch (error) {
                    if (window.sdUtils) {
                        window.sdUtils.showNotification('添加題目失敗：' + error.message, 'error');
                    } else {
                        alert('添加題目失敗：' + error.message);
                    }
                }
            });

            // 添加過濾器變化事件
            document.getElementById('filter-subject').addEventListener('change', updateExamsList);
            document.getElementById('filter-status').addEventListener('change', updateExamsList);
            document.getElementById('filter-question-subject').addEventListener('change', updateQuestionsList);
            document.getElementById('filter-type').addEventListener('change', updateQuestionsList);
            document.getElementById('filter-difficulty').addEventListener('change', updateQuestionsList);
            document.getElementById('search-questions').addEventListener('input', updateQuestionsList);

            // 確保模態框內容點擊不會關閉模態框
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            });

            // 更新統計數字的函數
            function updateStatistics() {
                if (!window.examSystem) {
                    console.error("examSystem is not initialized!");
                    return;
                }

                try {
                    const exams = window.examSystem.getExams();
                    const results = window.examSystem.getExamResults();
                    const questions = window.examSystem.getQuestions();

                    const totalExamsCount = exams.length;
                    const completedExamsCount = results.length;
                    const avgScore = results.length > 0 ?
                        (results.reduce((sum, result) => sum + result.score, 0) / results.length).toFixed(1) :
                        0;
                    const totalQuestionsCount = questions.length;

                    document.getElementById('total-exams-count').textContent = totalExamsCount;
                    document.getElementById('completed-exams-count').textContent = completedExamsCount;
                    document.getElementById('avg-score').textContent = avgScore;
                    document.getElementById('total-questions-count').textContent = totalQuestionsCount;
                } catch (error) {
                    console.error("Error updating statistics:", error);
                }
            }

            // 更新試卷列表的函數
            function updateExamsList() {
                const examsList = document.getElementById('exams-list').querySelector('tbody');
                const noExamsMessage = document.getElementById('no-exams-message');

                // 獲取過濾條件
                const filters = {
                    subject: document.getElementById('filter-subject').value,
                    status: document.getElementById('filter-status').value
                };

                // 處理 "all" 值
                if (filters.subject === 'all') filters.subject = null;
                if (filters.status === 'all') filters.status = null;

                // 獲取所有試卷
                const exams = window.examSystem.getExams(filters);

                // 清空列表
                examsList.innerHTML = '';

                if (exams.length === 0) {
                    noExamsMessage.style.display = 'block';
                    return;
                }

                noExamsMessage.style.display = 'none';

                // 排序試卷 - 最新的在前面
                const sortedExams = [...exams].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                // 填充試卷列表
                sortedExams.forEach(exam => {
                    const row = document.createElement('tr');

                    const createdDate = new Date(exam.created_at);
                    const formattedDate = createdDate.toLocaleDateString('zh-TW');

                    // 檢查是否已完成這個試卷
                    const results = window.examSystem.getExamResults();
                    const completed = results.some(result => result.exam_id === exam.id);

                    row.innerHTML = `
                        <td>${exam.title}</td>
                        <td>${getSubjectName(exam.subject)}</td>
                        <td>${exam.academic_year}</td>
                        <td>${exam.question_ids.length}</td>
                        <td>${exam.total_time}分鐘</td>
                        <td>${formattedDate}</td>
                        <td>${completed ? '<span style="color: var(--secondary-color);">已完成</span>' : '<span style="color: var(--warning-color);">未完成</span>'}</td>
                        <td class="actions">
                            <button class="btn start-exam" data-id="${exam.id}">${completed ? '重新考試' : '開始考試'}</button>
                            <button class="btn view-exam" data-id="${exam.id}">查看試卷</button>
                            <button class="btn btn-danger delete-exam" data-id="${exam.id}">刪除</button>
                        </td>
                    `;

                    // 添加事件監聽器
                    row.querySelector('.start-exam').addEventListener('click', function () {
                        const examId = this.dataset.id;
                        window.examSystem.startExam(examId);
                    });

                    row.querySelector('.view-exam').addEventListener('click', function () {
                        const examId = this.dataset.id;
                        viewExam(examId);
                    });

                    row.querySelector('.delete-exam').addEventListener('click', function () {
                        const examId = this.dataset.id;
                        if (confirm('確定要刪除此試卷嗎？此操作無法撤銷。')) {
                            window.examSystem.deleteExam(examId);
                            updateExamsList();
                            updateStatistics();
                        }
                    });

                    examsList.appendChild(row);
                });
            }

            // 更新問題列表的函數
            function updateQuestionsList() {
                const questionsList = document.getElementById('questions-list').querySelector('tbody');
                const noQuestionsMessage = document.getElementById('no-questions-message');

                // 獲取過濾條件
                const filters = {
                    subject: document.getElementById('filter-question-subject').value,
                    type: document.getElementById('filter-type').value,
                    difficulty: document.getElementById('filter-difficulty').value,
                    searchTerm: document.getElementById('search-questions').value
                };

                // 處理 "all" 值
                if (filters.subject === 'all') filters.subject = null;
                if (filters.type === 'all') filters.type = null;
                if (filters.difficulty === 'all') filters.difficulty = null;
                if (filters.searchTerm === '') filters.searchTerm = null;

                // 獲取過濾後的題目
                const questions = window.examSystem.getQuestions(filters);

                // 清空列表
                questionsList.innerHTML = '';

                if (questions.length === 0) {
                    noQuestionsMessage.style.display = 'block';
                    return;
                }

                noQuestionsMessage.style.display = 'none';

                // 填充題目列表
                questions.forEach(question => {
                    const row = document.createElement('tr');

                    // 截斷長題目內容
                    const shortContent = question.content.length > 50 ?
                        question.content.substring(0, 50) + '...' :
                        question.content;

                    row.innerHTML = `
                        <td>${getQuestionTypeName(question.type)}</td>
                        <td>${getSubjectName(question.subject)}</td>
                        <td>${question.academic_year}</td>
                        <td>${shortContent}</td>
                        <td><span class="tag tag-${question.difficulty}">${getDifficultyName(question.difficulty)}</span></td>
                        <td class="actions">
                            <button class="btn view-question" data-id="${question.id}">查看</button>
                            <button class="btn edit-question" data-id="${question.id}">編輯</button>
                            <button class="btn btn-danger delete-question" data-id="${question.id}">刪除</button>
                        </td>
                    `;

                    // 添加事件監聽器
                    row.querySelector('.view-question').addEventListener('click', function () {
                        const questionId = this.dataset.id;
                        viewQuestion(questionId);
                    });

                    row.querySelector('.edit-question').addEventListener('click', function () {
                        const questionId = this.dataset.id;
                        editQuestion(questionId);
                    });

                    row.querySelector('.delete-question').addEventListener('click', function () {
                        const questionId = this.dataset.id;
                        if (confirm('確定要刪除此題目嗎？此操作無法撤銷。')) {
                            window.examSystem.deleteQuestion(questionId);
                            updateQuestionsList();
                            updateStatistics();
                        }
                    });

                    questionsList.appendChild(row);
                });
            }

            // 更新近期考試結果的函數
            function updateRecentResults() {
                const resultsContainer = document.getElementById('recent-results-container');
                const noResultsMessage = document.getElementById('no-results-message');

                // 獲取所有考試結果
                const results = window.examSystem.getExamResults();

                if (results.length === 0) {
                    noResultsMessage.style.display = 'block';
                    return;
                }

                noResultsMessage.style.display = 'none';

                // 排序結果 - 最新的在前面
                const sortedResults = [...results].sort((a, b) => new Date(b.date) - new Date(a.date));

                // 只顯示最近5個結果
                const recentResults = sortedResults.slice(0, 5);

                // 清空容器
                resultsContainer.innerHTML = '';

                // 填充結果
                recentResults.forEach(result => {
                    const exam = window.examSystem.getExam(result.exam_id);
                    if (!exam) return; // 跳過找不到對應試卷的結果

                    const resultDate = new Date(result.date);
                    const formattedDate = resultDate.toLocaleDateString('zh-TW');

                    // 計算得分百分比
                    const scorePercentage = (result.score / result.total_score * 100).toFixed(1);

                    // 根據分數決定顏色
                    let scoreClass = '';
                    if (scorePercentage >= 80) {
                        scoreClass = 'high-score';
                    } else if (scorePercentage >= 60) {
                        scoreClass = 'medium-score';
                    } else {
                        scoreClass = 'low-score';
                    }

                    const resultElement = document.createElement('div');
                    resultElement.className = 'result-item';
                    resultElement.style = 'background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;';
                    resultElement.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <h3 style="margin: 0; color: var(--primary-dark);">${exam.title}</h3>
                                <p style="margin: 5px 0 0; color: #777;">${formattedDate}</p>
                            </div>
                            <div class="result-score ${scoreClass}">${scorePercentage}%</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn view-result" data-id="${result.id}">查看詳情</button>
                            <button class="btn btn-danger delete-result" data-id="${result.id}">刪除</button>
                        </div>
                    `;

                    // 添加事件監聽器
                    resultElement.querySelector('.view-result').addEventListener('click', function () {
                        const resultId = this.dataset.id;
                        viewResult(resultId);
                    });

                    resultElement.querySelector('.delete-result').addEventListener('click', function () {
                        const resultId = this.dataset.id;
                        if (confirm('確定要刪除此考試結果嗎？此操作無法撤銷。')) {
                            window.examSystem.deleteExamResult(resultId);
                            updateRecentResults();
                            updateStatistics();
                        }
                    });

                    resultsContainer.appendChild(resultElement);
                });
            }

            // 更新學習分析的函數
            function updateLearningAnalysis() {
                const analysisContainer = document.getElementById('learning-analysis');
                const noAnalysisMessage = document.getElementById('no-analysis-message');

                // 獲取所有考試結果
                const results = window.examSystem.getExamResults();

                if (results.length < 3) {
                    noAnalysisMessage.style.display = 'block';
                    return;
                }

                noAnalysisMessage.style.display = 'none';

                // 清空容器
                analysisContainer.innerHTML = '';

                // 分析數據
                const analysisData = window.examSystem.analyzeLearning();

                // 填充分析結果
                analysisData.forEach(item => {
                    const analysisElement = document.createElement('div');
                    analysisElement.className = 'analysis-item';
                    analysisElement.innerHTML = `
                        <div class="analysis-title">${item.title}</div>
                        <p>${item.content}</p>
                    `;
                    analysisContainer.appendChild(analysisElement);
                });
            }

            // 初始化圖表的函數
            function initializeCharts() {
                // 成績趨勢圖
                Highcharts.chart('score-trend-chart', {
                    chart: {
                        type: 'line'
                    },
                    title: {
                        text: '成績趨勢'
                    },
                    xAxis: {
                        categories: window.examSystem.getExamResults().map(result => new Date(result.date).toLocaleDateString('zh-TW'))
                    },
                    yAxis: {
                        title: {
                            text: '分數'
                        }
                    },
                    series: [{
                        name: '分數',
                        data: window.examSystem.getExamResults().map(result => result.score)
                    }]
                });

                // 題型分布圖
                Highcharts.chart('question-types-chart', {
                    chart: {
                        type: 'pie'
                    },
                    title: {
                        text: '題型分布'
                    },
                    series: [{
                        name: '題數',
                        colorByPoint: true,
                        data: window.examSystem.getQuestionTypeDistribution().map(item => ({
                            name: getQuestionTypeName(item.type),
                            y: item.count
                        }))
                    }]
                });
            }

            // 填充所有結果的函數
            function populateAllResults() {
                const allResultsContainer = document.getElementById('all-results-container');
                const noAllResultsMessage = document.getElementById('no-all-results-message');

                // 獲取過濾條件
                const filters = {
                    subject: document.getElementById('result-filter-subject').value,
                    dateRange: document.getElementById('result-filter-date').value
                };

                // 處理 "all" 值
                if (filters.subject === 'all') filters.subject = null;
                if (filters.dateRange === 'all') filters.dateRange = null;

                // 獲取所有考試結果
                const results = window.examSystem.getExamResults(filters);

                // 清空容器
                allResultsContainer.innerHTML = '';

                if (results.length === 0) {
                    noAllResultsMessage.style.display = 'block';
                    return;
                }

                noAllResultsMessage.style.display = 'none';

                // 填充結果
                results.forEach(result => {
                    const exam = window.examSystem.getExam(result.exam_id);
                    if (!exam) return; // 跳過找不到對應試卷的結果

                    const resultDate = new Date(result.date);
                    const formattedDate = resultDate.toLocaleDateString('zh-TW');

                    // 計算得分百分比
                    const scorePercentage = (result.score / result.total_score * 100).toFixed(1);

                    // 根據分數決定顏色
                    let scoreClass = '';
                    if (scorePercentage >= 80) {
                        scoreClass = 'high-score';
                    } else if (scorePercentage >= 60) {
                        scoreClass = 'medium-score';
                    } else {
                        scoreClass = 'low-score';
                    }

                    const resultElement = document.createElement('div');
                    resultElement.className = 'result-item';
                    resultElement.style = 'background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;';
                    resultElement.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <h3 style="margin: 0; color: var(--primary-dark);">${exam.title}</h3>
                                <p style="margin: 5px 0 0; color: #777;">${formattedDate}</p>
                            </div>
                            <div class="result-score ${scoreClass}">${scorePercentage}%</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn view-result" data-id="${result.id}">查看詳情</button>
                            <button class="btn btn-danger delete-result" data-id="${result.id}">刪除</button>
                        </div>
                    `;

                    // 添加事件監聽器
                    resultElement.querySelector('.view-result').addEventListener('click', function () {
                        const resultId = this.dataset.id;
                        viewResult(resultId);
                    });

                    resultElement.querySelector('.delete-result').addEventListener('click', function () {
                        const resultId = this.dataset.id;
                        if (confirm('確定要刪除此考試結果嗎？此操作無法撤銷。')) {
                            window.examSystem.deleteExamResult(resultId);
                            populateAllResults();
                            updateStatistics();
                        }
                    });

                    allResultsContainer.appendChild(resultElement);
                });
            }

            // 顯示試卷詳情的函數
            function viewExam(examId) {
                const exam = window.examSystem.getExam(examId);
                if (!exam) return;

                const modal = document.getElementById('question-detail-modal');
                const content = document.getElementById('question-detail-content');

                content.innerHTML = `
                    <h2>${exam.title}</h2>
                    <p>${exam.description}</p>
                    <p>科目：${getSubjectName(exam.subject)}</p>
                    <p>學年：${exam.academic_year}</p>
                    <p>總分：${exam.total_score}</p>
                    <p>考試時間：${exam.total_time}分鐘</p>
                    <p>題目數量：${exam.question_ids.length}</p>
                    <p>難度：${getDifficultyName(exam.difficulty)}</p>
                    <h3>題目列表</h3>
                    <ul>
                        ${exam.question_ids.map(id => {
                    const question = window.examSystem.getQuestion(id);
                    return `<li>${question ? question.content : '題目已刪除'}</li>`;
                }).join('')}
                    </ul>
                `;

                modal.style.display = 'block';
            }

            // 顯示題目詳情的函數
            function viewQuestion(questionId) {
                const question = window.examSystem.getQuestion(questionId);
                if (!question) return;

                const modal = document.getElementById('question-detail-modal');
                const content = document.getElementById('question-detail-content');

                content.innerHTML = `
                    <h2>${getQuestionTypeName(question.type)}</h2>
                    <p>${question.content}</p>
                    <p>科目：${getSubjectName(question.subject)}</p>
                    <p>學年：${question.academic_year}</p>
                    <p>難度：${getDifficultyName(question.difficulty)}</p>
                    <p>章節：${question.chapter || '無'}</p>
                    <p>作答時間：${question.time_limit}秒</p>
                    <p>解析：${question.explanation || '無'}</p>
                    <p>標籤：${question.tags.join(', ') || '無'}</p>
                    <h3>答案</h3>
                    ${getAnswerContent(question)}
                `;

                modal.style.display = 'block';
            }

            // 顯示考試結果詳情的函數
            function viewResult(resultId) {
                const result = window.examSystem.getExamResult(resultId);
                if (!result) return;

                const exam = window.examSystem.getExam(result.exam_id);
                if (!exam) return;

                const modal = document.getElementById('exam-result-modal');
                const content = document.getElementById('exam-result-content');

                content.innerHTML = `
                    <h2>${exam.title}</h2>
                    <p>科目：${getSubjectName(exam.subject)}</p>
                    <p>學年：${exam.academic_year}</p>
                    <p>總分：${exam.total_score}</p>
                    <p>得分：${result.score}</p>
                    <p>考試時間：${exam.total_time}分鐘</p>
                    <p>完成時間：${new Date(result.date).toLocaleDateString('zh-TW')}</p>
                    <h3>答題詳情</h3>
                    <ul>
                        ${result.answers.map(answer => {
                    const question = window.examSystem.getQuestion(answer.question_id);
                    return `<li>${question ? question.content : '題目已刪除'} - ${answer.correct ? '正確' : '錯誤'}</li>`;
                }).join('')}
                    </ul>
                `;

                modal.style.display = 'block';
            }

            // 編輯題目的函數
            function editQuestion(questionId) {
                const question = window.examSystem.getQuestion(questionId);
                if (!question) return;

                const modal = document.getElementById('add-question-modal');
                const form = document.getElementById('add-question-form');

                form.elements.subject.value = question.subject;
                form.elements.academic_year.value = question.academic_year;
                form.elements.question_type.value = question.type;
                form.elements.difficulty.value = question.difficulty;
                form.elements.content.value = question.content;
                form.elements.chapter.value = question.chapter || '';
                form.elements.time_limit.value = question.time_limit;
                form.elements.explanation.value = question.explanation || '';
                form.elements.tags.value = question.tags.join(', ');

                // 顯示對應的答案區域
                document.getElementById('question-type').dispatchEvent(new Event('change'));

                // 填充答案
                switch (question.type) {
                    case 'true_false':
                        form.elements.tf_answer.value = question.answer ? 'true' : 'false';
                        break;

                    case 'single_choice':
                        const singleOptionsContainer = document.getElementById('single-options-container');
                        singleOptionsContainer.innerHTML = '';
                        question.options.forEach((option, index) => {
                            const optionGroup = document.createElement('div');
                            optionGroup.className = 'option-group';
                            optionGroup.innerHTML = `
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <input type="radio" name="single_answer" class="option-checkbox" ${index === question.answer ? 'checked' : ''} required>
                                    <input type="text" class="option-text" value="${option}" required>
                                    <button type="button" class="btn btn-danger remove-option">刪除</button>
                                </div>
                            `;
                            singleOptionsContainer.appendChild(optionGroup);

                            // 綁定刪除按鈕事件
                            optionGroup.querySelector('.remove-option').addEventListener('click', function () {
                                singleOptionsContainer.removeChild(optionGroup);
                            });
                        });
                        break;

                    case 'multiple_choice':
                        const multipleOptionsContainer = document.getElementById('multiple-options-container');
                        multipleOptionsContainer.innerHTML = '';
                        question.options.forEach((option, index) => {
                            const optionGroup = document.createElement('div');
                            optionGroup.className = 'option-group';
                            optionGroup.innerHTML = `
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <input type="checkbox" class="option-checkbox" ${question.answer.includes(index) ? 'checked' : ''}>
                                    <input type="text" class="option-text" value="${option}" required>
                                    <button type="button" class="btn btn-danger remove-option">刪除</button>
                                </div>
                            `;
                            multipleOptionsContainer.appendChild(optionGroup);

                            // 綁定刪除按鈕事件
                            optionGroup.querySelector('.remove-option').addEventListener('click', function () {
                                multipleOptionsContainer.removeChild(optionGroup);
                            });
                        });
                        break;

                    case 'fill_blank':
                        const blanksContainer = document.getElementById('blanks-container');
                        blanksContainer.innerHTML = '';
                        question.answer.forEach((blank, index) => {
                            const blankGroup = document.createElement('div');
                            blankGroup.style = 'display: flex; gap: 10px; margin-bottom: 10px;';
                            blankGroup.innerHTML = `
                                <input type="text" class="blank-answer" value="${blank}" required>
                                <button type="button" class="btn btn-danger remove-blank">刪除</button>
                            `;
                            blanksContainer.appendChild(blankGroup);

                            // 綁定刪除按鈕事件
                            blankGroup.querySelector('.remove-blank').addEventListener('click', function () {
                                blanksContainer.removeChild(blankGroup);
                            });
                        });
                        break;

                    case 'short_answer':
                        form.elements.short_answer.value = question.answer;
                        form.elements.keywords.value = question.keywords.join(', ');
                        break;
                }

                modal.style.display = 'block';
            }

            // 獲取科目名稱的函數
            function getSubjectName(subject) {
                if (window.sdUtils && window.sdUtils.getSubjectName) {
                    return window.sdUtils.getSubjectName(subject);
                }

                switch (subject) {
                    case 'chinese': return '國文';
                    case 'english': return '英文';
                    case 'math': return '數學';
                    case 'science': return '自然';
                    case 'social': return '社會';
                    default: return '未知';
                }
            }

            // 獲取題型名稱的函數
            function getQuestionTypeName(type) {
                if (window.sdUtils && window.sdUtils.getQuestionTypeName) {
                    return window.sdUtils.getQuestionTypeName(type);
                }

                switch (type) {
                    case 'true_false': return '是非題';
                    case 'single_choice': return '單選題';
                    case 'multiple_choice': return '多選題';
                    case 'fill_blank': return '填空題';
                    case 'short_answer': return '簡答題';
                    default: return '未知';
                }
            }

            // 獲取難度名稱的函數
            function getDifficultyName(difficulty) {
                if (window.sdUtils && window.sdUtils.getDifficultyName) {
                    return window.sdUtils.getDifficultyName(difficulty);
                }

                switch (difficulty) {
                    case 'easy': return '基礎';
                    case 'medium': return '中等';
                    case 'hard': return '進階';
                    case 'mixed': return '混合';
                    default: return '未知';
                }
            }

            // 獲取答案內容的函數
            function getAnswerContent(question) {
                switch (question.type) {
                    case 'true_false':
                        return `<p>${question.answer ? '正確' : '錯誤'}</p>`;

                    case 'single_choice':
                        return `
                            <ul>
                                ${question.options.map((option, index) => `<li>${option} ${index === question.answer ? '(正確答案)' : ''}</li>`).join('')}
                            </ul>
                        `;

                    case 'multiple_choice':
                        return `
                            <ul>
                                ${question.options.map((option, index) => `<li>${option} ${question.answer.includes(index) ? '(正確答案)' : ''}</li>`).join('')}
                            </ul>
                        `;

                    case 'fill_blank':
                        return `
                            <ul>
                                ${question.answer.map((blank, index) => `<li>填空${index + 1}：${blank}</li>`).join('')}
                            </ul>
                        `;

                    case 'short_answer':
                        return `
                            <p>${question.answer}</p>
                            <p>關鍵詞：${question.keywords.join(', ')}</p>
                        `;

                    default:
                        return '<p>未知題型</p>';
                }
            }
        });
    </script>
</body>

</html>